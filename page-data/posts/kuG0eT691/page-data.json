{"componentChunkName":"component---src-templates-blog-post-js","path":"/posts/kuG0eT691/","result":{"data":{"markdownRemark":{"id":"83a117e4-67e4-57c5-aea2-c0b0ed0383dd","excerpt":"記事一覧 その1（調査編） その2（USB編） その3（Nucleo編） その4（ケーブル編） その5（最終章）　←ココ 　 PS1と通信 PS1につなぎ変えて、通信してみる……動かない。 色々調べたらいくつかの問題が発生していた。 ACKタイミング問題 動かないのでPS1とPS…","html":"<p>記事一覧</p>\n<ul>\n<li><a href=\"/posts/mmx5El0Si\">その1（調査編）</a></li>\n<li><a href=\"/posts/2stNWIQ7Z\">その2（USB編）</a></li>\n<li><a href=\"/posts/vORCOiXb_\">その3（Nucleo編）</a></li>\n<li><a href=\"/posts/2fluV8sa5\">その4（ケーブル編）</a></li>\n<li><a href=\"/posts/kuG0eT691\">その5（最終章）</a>　←ココ</li>\n</ul>\n<p>　</p>\n<h1 id=\"PS1と通信\">PS1と通信</h1>\n<p>PS1につなぎ変えて、通信してみる……動かない。</p>\n<p>色々調べたらいくつかの問題が発生していた。</p>\n<h2 id=\"ACKタイミング問題\">ACKタイミング問題</h2>\n<p>動かないのでPS1とPS1コントローラーの実際の通信をロジアナで確認。</p>\n<p><img src=\"/7e721fd65e97792c21352726c091c923/pic01.jpg\" alt=\"\"></p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/6f4374a8d3ee24c6e6e0ef5f05ec5d83/2bfc7/pic02.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 48.64864864864865%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAIAAAA7N+mxAAAACXBIWXMAAA7DAAAOwwHHb6hkAAAB/klEQVR42iWI7W/SQACH+9dvEZyf8YOJIEqi0c2QRdjALUzeR3u9610L9OVaSgsF5EWgpbQ9Azx58uSXH3edbVzn2qls/W2+fVN4fVfo3hS66c+d9Kd6KnfyTb6dyrcvvXiV72S+/Elf5bjFzF2v5v52MfYWnuctFrOlN13OnOV8sl66/n7OouAY/EuO+zjcxeEuOe7D/Yax5L5OuDAMfT84RtFmFxB9UheGsmqvVms/OBwO4W6/TxLm+0EUx4cwPIRhFMc732eMleoyxxiLk5idieJk8nebnGGMJefz0stIWBKzOIwixtivOuE8qg4MdUSpTamlU14kFjVsalqGMTZNm550THNEqXP6NJWqqq55U6tw3+BGOnyVeIEIgAAAQaXZECQeI4QJxBhKEpQIRFgEWEAYCljgiQCQqGrSh+8VTh20YB9DBUqyiDD/3OlAAhRZwARgzBMZSFiQFYCISBSAFCjKEGGemuTj3TPXwz2eB4ZutKCYKRWf2oKkKJlysSmCn43a19rvp143Wy11EMyUi12EqE6z1XJVaN0+9LjNamFbZuBvx/r44bYtD8zlfF65a9m6DVpyt4Y0YryUeIc6jz9aruUe/O1Lmdeh9tgkHNGnaOjCgSOprqK7DZECZdQ3JtLQkTVX1l2suorhSkOnf644cIjmmOP5+2+N/0iw/OKzKGO+AAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"pic02\"\n        title=\"\"\n        src=\"/static/6f4374a8d3ee24c6e6e0ef5f05ec5d83/fcda8/pic02.png\"\n        srcset=\"/static/6f4374a8d3ee24c6e6e0ef5f05ec5d83/12f09/pic02.png 148w,\n/static/6f4374a8d3ee24c6e6e0ef5f05ec5d83/e4a3f/pic02.png 295w,\n/static/6f4374a8d3ee24c6e6e0ef5f05ec5d83/fcda8/pic02.png 590w,\n/static/6f4374a8d3ee24c6e6e0ef5f05ec5d83/efc66/pic02.png 885w,\n/static/6f4374a8d3ee24c6e6e0ef5f05ec5d83/c83ae/pic02.png 1180w,\n/static/6f4374a8d3ee24c6e6e0ef5f05ec5d83/2bfc7/pic02.png 1227w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p>ACKのタイミングがSPIの送受信後、数usしてから行われていた。送受信直後にACKしていたのでPS1が認識できていなかったらしい。ということで、10us待ってからACKするように修正。</p>\n<h2 id=\"フェイントSSATT問題\">フェイントSS(ATT)問題</h2>\n<p>PS1とPS1コントローラーの実際の通信を見ていると、PSが謎のSS信号を一瞬出していることが分かった。</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/aab2e12c41298b8f1902fe95516d5c55/fe9e8/pic03.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 48.64864864864865%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAYAAAC0VX7mAAAACXBIWXMAABcRAAAXEQHKJvM/AAACB0lEQVR42m2M+0/aUBzF+9cvc+LPS5Ysy5zMxb3iXKIxPhEQEei9fVCgoEZoEVoYOBgFCp+F+oguO8kn53vOubnK0mqapbUzlt+nWIlnWFnPEfuYJbZ+zsr6ObG19CPL8TOW49loX/gix+JZXq5lefMpxasXH1C8tkOv2yb43WFw22XQ9wmGfYbdNp1WnZ5/Q6/rMhp6MB0xnwyZBreRz8MR4WRIOB4AMzYTJsp0NmM8nrLQZDojGE/u75A/o4DZHKZhSDAe86CH94wn3Ho+wSSM4nayhDLod3FuHHyvTcf38H0Pz2tH3un4+J5Hx/dpeS0aNw3cloPjNXGvqjTPM1ynElxWLHoDn8+7OZSaSJI3BLquYugCqRUoapKifoepi6jXdBVhCnRDopoCoeXRj/cwEvuoMkflwmD1xwmKU9cRRR1pqNFnwhBosoAQeaTIIRadzN/thkDKPJqloVk6WlEiixK1qFG9MHn75QBFNbMYphGVh4U0umVwUEiTklmO1QzHhdOIjJZDswz280nsaoWSXaJslyOscol6vca7b0cotasapmGiGzZbP1PYlUs2t5IcHhXY3sk8cpIUWFaNr98TtFotHMfFdZsR9YZL/5fPxk4OhWea/8fnTzL/3M+1e1pCMWtNZNlBq7hI273ziotabqDZzaiL+oft3p8iSg7Va4/XGyn+AoqUx8kLHGnmAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"pic03\"\n        title=\"\"\n        src=\"/static/aab2e12c41298b8f1902fe95516d5c55/fcda8/pic03.png\"\n        srcset=\"/static/aab2e12c41298b8f1902fe95516d5c55/12f09/pic03.png 148w,\n/static/aab2e12c41298b8f1902fe95516d5c55/e4a3f/pic03.png 295w,\n/static/aab2e12c41298b8f1902fe95516d5c55/fcda8/pic03.png 590w,\n/static/aab2e12c41298b8f1902fe95516d5c55/efc66/pic03.png 885w,\n/static/aab2e12c41298b8f1902fe95516d5c55/fe9e8/pic03.png 1146w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p>※SS信号が無いときにもMOSIが来ているが、これは2P用の信号</p>\n<p>Nucleo側ではSSピンの立下りで割り込みをかけているので、これに引っかかって通信を開始してしまい不具合が起きていたようだ。ということで、割り込み後少し待ってからSSピンを確認してLOWだったら通信開始とするように修正。</p>\n<h2 id=\"SPIバッファ問題\">SPIバッファ問題</h2>\n<p>どうもよく分からないが、STM32F4ではSPI通信がズレた時にバッファにゴミが残ってしまい、次の通信に影響が出てしまうらしい。ということで、毎回通信後に__HAL_SPI_DISABLE(&#x26;SPI_Slave_Handle);を呼び出してバッファクリアを行うことでなんとか解決した。</p>\n<p>そのほかにもいくつか細かいことで詰まったが、上の3つがなかなか厄介だった。</p>\n<h1 id=\"通信成功\">通信成功！</h1>\n<p>PS版の雷電をUBSゲームパッドで遊ぶことに成功した。わーいわーい。</p>\n<p><img src=\"/551524933668fe08d97126a965781c01/pic04.jpg\" alt=\"\"></p>\n<h1 id=\"アケコンコンフィグ\">アケコン＋コンフィグ</h1>\n<p>本来の目的であるアケコンで遊ぶために、Qanba Droneというアケコンを買って繋いでみた。実はここでも躓いていて、なぜか受信するデータが1バイトずれて読み込まれてしまった。色々調べたけど結局原因はよく分かっていなくて、Qanba Droneにつなぐときは8bitオフセットをかけるという対処を行うことにした。<br>\nプログラムをいちいち書き換えるのは面倒なのでSDカードで設定を行えるようにした。加えて、ゲームパッドごとにボタンの配置が違うため、それもSDカードで設定できるようにした。</p>\n<p>コンフィグファイルはこんな感じ</p>\n<div class=\"gatsby-highlight\" data-language=\"ini\"><pre class=\"language-ini\"><code class=\"language-ini\"><span class=\"token key attr-name\">OFFSET</span><span class=\"token punctuation\">=</span><span class=\"token value attr-value\">0</span>\r\n\r\n<span class=\"token section\"><span class=\"token punctuation\">[</span><span class=\"token section-name selector\">KEY_CONFIG</span><span class=\"token punctuation\">]</span></span>\r\n<span class=\"token key attr-name\">O</span><span class=\"token punctuation\">=</span><span class=\"token value attr-value\">3</span>\r\n<span class=\"token key attr-name\">X</span><span class=\"token punctuation\">=</span><span class=\"token value attr-value\">2</span>\r\n<span class=\"token key attr-name\">TRI</span><span class=\"token punctuation\">=</span><span class=\"token value attr-value\">1</span>\r\n<span class=\"token key attr-name\">SQUARE</span><span class=\"token punctuation\">=</span><span class=\"token value attr-value\">0</span>\r\n\r\n<span class=\"token key attr-name\">L1</span><span class=\"token punctuation\">=</span><span class=\"token value attr-value\">4</span>\r\n<span class=\"token key attr-name\">R1</span><span class=\"token punctuation\">=</span><span class=\"token value attr-value\">5</span>\r\n<span class=\"token key attr-name\">L2</span><span class=\"token punctuation\">=</span><span class=\"token value attr-value\">6</span>\r\n<span class=\"token key attr-name\">R2</span><span class=\"token punctuation\">=</span><span class=\"token value attr-value\">7</span>\r\n\r\n<span class=\"token key attr-name\">SELECT</span><span class=\"token punctuation\">=</span><span class=\"token value attr-value\">10</span>\r\n<span class=\"token key attr-name\">START</span><span class=\"token punctuation\">=</span><span class=\"token value attr-value\">11</span></code></pre></div>\n<p><img src=\"/86f74fb197d6264304d6d4a851519d80/pic05.jpg\" alt=\"\"></p>\n<p>ちなみに、Qanba DroneはPS4モードで使う。</p>\n<h1 id=\"基板作成\">基板作成</h1>\n<p>ブレッドボードだとアレなので、基板も作った。</p>\n<p>裏側\r\n<img src=\"/eb2375f1a63abaf9ef4639088fb93f65/pic06.jpg\" alt=\"\"></p>\n<br>\n<p>ホストシールドのジャンパも直接接続してみる。\r\n<img src=\"/dbb3853fcecdaa380fa8fc75a281c6c5/pic07.jpg\" alt=\"\"></p>\n<br>\n<p>完成！\r\n<img src=\"/653662ce842fcfde0975e89c4e6785cc/pic08.jpg\" alt=\"\"></p>\n<br>\n<p>イエーイ\r\n<img src=\"/3636f98fad7b65aa56832ac34e00934c/pic09.jpg\" alt=\"\"></p>\n<br>\n<p>一応プログラムは<a href=\"https://github.com/gyojir/UsbToPSXConverter\">コチラ</a>にのせときます。</p>","frontmatter":{"title":"USB GamePad to PSX Controller Converter を作った(5)","date":"2019-02-17T23:07:03.000+09:00","description":"","tags":["製作記"]}}},"pageContext":{"slug":"/posts/kuG0eT691","previous":{"fields":{"slug":"/posts/2fluV8sa5"},"frontmatter":{"title":"USB GamePad to PSX Controller Converter を作った(4)"}},"next":{"fields":{"slug":"/posts/JWrvctPdA"},"frontmatter":{"title":"USB GamePad to PSX Controller Converter を作った(まとめ)"}}}},"staticQueryHashes":["2841359383","3115688470","3159585216","523898683","998201107"],"slicesMap":{}}