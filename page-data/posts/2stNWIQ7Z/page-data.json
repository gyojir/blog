{"componentChunkName":"component---src-templates-blog-post-js","path":"/posts/2stNWIQ7Z/","result":{"data":{"markdownRemark":{"id":"a68d6fc9-0f1d-5e4c-abcb-329fb10384c1","excerpt":"記事一覧 その1（調査編） その2（USB編）　←ココ その3（Nucleo編） その4（ケーブル編） その5（最終章） USBゲームパッド読み込み Arduino用のUSBホストシールドを購入。 Arduino IDEでUSB Host Shield Library 2.…","html":"<p>記事一覧</p>\n<ul>\n<li><a href=\"/posts/mmx5El0Si\">その1（調査編）</a></li>\n<li><a href=\"/posts/2stNWIQ7Z\">その2（USB編）</a>　←ココ</li>\n<li><a href=\"/posts/vORCOiXb_\">その3（Nucleo編）</a></li>\n<li><a href=\"/posts/2fluV8sa5\">その4（ケーブル編）</a></li>\n<li><a href=\"/posts/kuG0eT691\">その5（最終章）</a></li>\n</ul>\n<h1 id=\"USBゲームパッド読み込み\">USBゲームパッド読み込み</h1>\n<p>Arduino用のUSBホストシールドを購入。<br>\nArduino IDEで<a href=\"https://www.arduinolibraries.info/libraries/usb-host-shield-library-2-0\">USB Host Shield Library 2.0</a>をインストール。サンプルのUSBHIDJoystickを使ってみる。</p>\n<br>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 480px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/f0c93ec7e301ed4a0a07e1a84f29e833/e85cb/arduino-screenshot.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 116.21621621621622%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAXCAIAAACEf/j0AAAACXBIWXMAAA7DAAAOwwHHb6hkAAADT0lEQVR42o2SS28TVxiGh10r2LRIwVCJVX8CSJUcaCl2QN1V6g9g1x9Q0SpRFzSEFJRmRVUIItTELYu2AiE2TYtoURAXtbbj2PGMZ8aem2fm2Gfm3GacGceXQR63iDSpkk/P5hydR++nV4c7N//o/NWHXy2uXFh8cun28+nMs8mFP6cWHk1e+33y2sMRUwt/TN14/IovFh5/feO36/N3uCc5UauLrtM0G9rAp9PLv74x9eXR2ctHZmaPzMwenrk05OLM6ySmL75z+cq7cze5lbxcKJaKFUkHruuQ+7w4m1+by61e+bswly/Or5a2802hdLW8fmH5Gbf8XFrla4bj84rNq02KKDXNtuNEGxs9z+t3u9G2GQwGURSJqsO9WJXrsthoGIauaYrShK1iuVypiiZoAgi9IOj0+2Gv9zpBtzuIoqIMuL9Kiq4ppmnZNlBV1XEcQRA0XSeUuq7b2dwcRm2lHyev11vc07woCBWMia7rmq4jhPhKxbZt3/dd192M5R3XriiQy/M6o9iLn2KMCcGCINTkmmVZu8tSg7w6R1HEGJMlSeAFRVEghN3/L2woiwYenUdXlFKB523btkwTALCLLBn/Ta6sVwAAvu8jhHZbe6tMKVXqCmg2McYIIQghIcTzvE6nsye5JsuEEMYYwtgwDFmuYYzDMNyTzPN8q9VC8QDbksSqbVt7SmZxYYZhQAgRwqJi1oymCQnCJAyDMAyDIOh0Nv/5JNuTxaoIIWSMuQjVNHONl22HGEZDU7VRi8zzdpYJIZZpeZ6H47EahiSKHqPAttZL5UbDoJT6fntnmTGmqpqqqpZl4bgwSZIJoZZl53KFfKFYUzSE6b/y1h9GKKlWhaoompaJCTZNs1wqAQBEDay8KD7NldekRgv7w8LqLU6I5e5g0IuiXhRRL1QUS1XtumpDl5mgWZGkJkKk3WZBQNsbLAiDXj+KopICudPf/XBmKTuRGZL6funTn+5N3n3w2c/3zv9y//O7Dz66lfng5q3UYiadWTq79OOIM7ezZ7PZD7/Ncm++fZTjOG7fPm7vEz8eigdPfrz/WPLA8fcPHD+5/9iJt947dXh8YiyZGkumEuPpQ8lUTHpsPH0oJnEinRifSCRPJ0598hIlUFqgz3acwQAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"arduino screenshot\"\n        title=\"\"\n        src=\"/static/f0c93ec7e301ed4a0a07e1a84f29e833/e85cb/arduino-screenshot.png\"\n        srcset=\"/static/f0c93ec7e301ed4a0a07e1a84f29e833/12f09/arduino-screenshot.png 148w,\n/static/f0c93ec7e301ed4a0a07e1a84f29e833/e4a3f/arduino-screenshot.png 295w,\n/static/f0c93ec7e301ed4a0a07e1a84f29e833/e85cb/arduino-screenshot.png 480w\"\n        sizes=\"(max-width: 480px) 100vw, 480px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<br>\n<p>手持ちのゲームパッドJC-U3613Mをつなげると反応はするが、ボタンと表示が合わなかった。<br>\nプログラムを見てみると、何バイト目がボタン、何バイト目がジョイスティックという具合に決め打ちになっていた。<br>\nこれを手持ちのゲームパッドに合わせて設定するということもできるけど、それだと違うゲームパッドを使いたくなったときに困るし、新しく対応するたびに何バイト目がボタンで…とかやるのはとてもダサい。</p>\n<p>ということで、もっとスマートな方法が無いか調べた。</p>\n<h1 id=\"HID--Report-Descriptor\">HID / Report Descriptor</h1>\n<p>USBのゲームパッドはHID(Human Interface Device)である。<br>\nHIDについてはいくらでも情報があると思うので特に説明はしないけど、ここで重要なキーワードが出てくる。</p>\n<h2 id=\"Report-Descriptor\">Report Descriptor</h2>\n<p>簡単に説明すると、HIDはそれぞれデバイスごとにReport Descriptorというモノを定義していて、そこに、何バイト目から何ビットがボタンで、何バイト目がジョイスティックのX軸で、何バイト目がハットスイッチで…みたいな情報が入っている。<br>\nこう書くと簡単そうだけど結構分かりにくくて、ちょっとしたスクリプトのような形式になっている。<br>\nそいつを上から順番にパースしていくことで情報が取得できる。基本的には変数のようなものに入力/出力の特性（例えばボタン、スティックのX軸といった種類、ビット数、最大値最小値、etc…）を格納して、Input/Outputアイテムによってその時点で格納されている情報を入力/出力として登録…という流れになっている。<br>\nReport Descriptorについてもっと詳しく知りたければ、<a href=\"http://wiki.onakasuita.org/pukiwiki/?%E3%83%AC%E3%83%9D%E3%83%BC%E3%83%88%E3%83%87%E3%82%A3%E3%82%B9%E3%82%AF%E3%83%AA%E3%83%97%E3%82%BF\">コチラ</a>のページが分かりやすいのでお勧め。</p>\n<p>てなわけで、Report Descriptorを使えばスマートにデータが取得できそう。ということが分かった。</p>\n<h2 id=\"Report-Descriptorのパース\">Report Descriptorのパース</h2>\n<p>何やら面倒くさそうだけど、実はさっきの<a href=\"https://www.arduinolibraries.info/libraries/usb-host-shield-library-2-0\">USB Host Shield Library 2.0</a>にはUSBHID_descというモロにストライクなサンプルがある。<br>\nとにかくこいつを使って手持ちのゲームパッドを読み込んでみたところ、どうやらバグっていた。ので直して<a href=\"https://github.com/felis/USB_Host_Shield_2.0/pull/438\">プルリク</a>してみた。<br>\n修正内容は以下の通り。</p>\n<ul>\n<li>グローバルアイテムをメインアイテムの後にリセットしないよう修正</li>\n<li>トグルエラー発生時の処理を修正\n<ul>\n<li>これを直すとロジクールのF310が動くようになった</li>\n</ul>\n</li>\n<li>ビットの読み込みバグ修正</li>\n</ul>\n<p>まあ、間違ってるかもだしプルリクの作法もよく分からないけど、あとはあっちで良しなにやってくれると信じよう。</p>\n<p>とりあえず、USBゲームパッドは読み込めるようになった。<br>\n<br>\r\n<br>\r\nつづく。</p>","frontmatter":{"title":"USB GamePad to PSX Controller Converter を作った(2)","date":"2019-01-21T01:07:34.000+09:00","description":"","tags":["製作記"]}}},"pageContext":{"slug":"/posts/2stNWIQ7Z","previous":{"fields":{"slug":"/posts/mmx5El0Si"},"frontmatter":{"title":"USB GamePad to PSX Controller Converter を作った(1)"}},"next":{"fields":{"slug":"/posts/vORCOiXb_"},"frontmatter":{"title":"USB GamePad to PSX Controller Converter を作った(3)"}}}},"staticQueryHashes":["2841359383","3115688470","3159585216","523898683","998201107"],"slicesMap":{}}