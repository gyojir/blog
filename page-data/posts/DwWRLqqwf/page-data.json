{"componentChunkName":"component---src-templates-blog-post-js","path":"/posts/DwWRLqqwf/","result":{"data":{"markdownRemark":{"id":"c493256a-8795-5fb4-9d75-e171c150815c","excerpt":"はじめに キオスク端末化した(フルスクリーンでアプリ起動。タッチ操作のみ)ラズパイで、オンスクリーンキーボードを使って日本語入力を行う方法の備忘録です。 要件 アプリはhtml+javascriptで、chromium-browserのkiosk…","html":"<h2 id=\"はじめに\">はじめに</h2>\n<p>キオスク端末化した(フルスクリーンでアプリ起動。タッチ操作のみ)ラズパイで、オンスクリーンキーボードを使って日本語入力を行う方法の備忘録です。</p>\n<br/>\n<h2 id=\"要件\">要件</h2>\n<ul>\n<li>アプリはhtml+javascriptで、chromium-browserのkioskモードで起動する</li>\n<li>テキストボックスにフォーカスするとオンスクリーンキーボードが出て、フォーカスを外すとキーボードが消えてほしい</li>\n<li>デフォルトがローマ字入力モードで、変換も可能にしたい</li>\n<li>タッチスクリーンのみで操作</li>\n</ul>\n<br/>\n<h2 id=\"手順\">手順</h2>\n<h3 id=\"1-matchbox-keyboardをインストールする\">1. matchbox-keyboardをインストールする</h3>\n<p>aptでインストールするとバージョンが古くdaemonモードが使えないため、githubのソースコードからインストールします。\r\nxmlファイルでレイアウトを変更することもできるので、キオスク端末に適しています。</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">sudo apt update\r\nsudo apt upgrade\r\nsudo apt install -y autoconf automake libtool\r\nsudo apt install -y libfakekey-dev libmatchbox-dev\r\ngit clone https://github.com/xlab/matchbox-keyboard\r\ncd matchbox-keyboard\r\nautoreconf -v --install\r\n./configure\r\nmake\r\nsudo make install\r\nsudo apt install -y fonts-takao</code></pre></div>\n<br/>\n<p>※ 文字化けしたのでフォントもインストールしています。</p>\n<br/>\n<p>インストールしたら以下のコマンドでオンスクリーンキーボードが出せます。</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">matchbox-keyboard</code></pre></div>\n<br/>\n<h3 id=\"2-fcitx-mozc-をインストールする\">2. fcitx-mozc をインストールする</h3>\n<p><a href=\"https://fcitx-im.org/wiki/Fcitx\">Fcitx</a>は文字入力の制御ソフト(インプットメソッドフレームワーク)です。\r\nfcitx-mozcはそれの日本語変換エンジンらしいです。\r\nラズパイには最初から入ってるかも？</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">sudo apt install -y fcitx fcitx-mozc\r\nim-config -n fcitx\r\nsudo reboot</code></pre></div>\n<br/>\n<p>[設定]→[Fcitx 設定]の[入力メソッド]タブでMozcを追加し、優先順位を矢印で上に変更するとデフォルトがローマ字入力になる。</p>\n<br/>\n<h3 id=\"3-fcitx-matchbox-keyboard-toggler-をインストールする\">3. fcitx-matchbox-keyboard-toggler をインストールする</h3>\n<p><a href=\"https://github.com/gyojir/fcitx-matchbox-keyboard-toggler\">fcitx-matchbox-keyboard-toggler</a>\r\nは自作のFcitxアドオンです。\r\nFcitxの入力イベントにフックすることで、入力フォーカスの切り替わりでmatchbox-keyboardをオンオフできます。</p>\n<p>matchbox-keyboardのオンオフは以下の実装を参考にしています。<br/>\r\n<a href=\"https://github.com/xlab/matchbox-keyboard/tree/matchbox-keyboard-xlab/gtk-im\">https://github.com/xlab/matchbox-keyboard/tree/matchbox-keyboard-xlab/gtk-im</a><br/>\r\nこれを使ってもmatchbox-keyboardの自動オンオフは可能になりますが、gtk専用インプットメソッドとして実装されているため、\r\nインプットメソッドであるFcitxと競合してしまいます。</p>\n<p>インストール手順は以下の通り</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">sudo apt install -y fcitx-libs-dev libx11-dev cmake\r\ngit clone https://github.com/gyojir/fcitx-matchbox-keyboard-toggler\r\ncd fcitx-matchbox-keyboard-toggler\r\nmkdir build\r\ncd build\r\ncmake ..\r\nmake\r\nsudo make install\r\nsudo reboot</code></pre></div>\n<br/>\n<p>アドオンが有効になっているかの確認は以下のコマンドで、有効なアドオンの一覧に”fcitx-matchbox-keyboard-toggler”が出ているかどうかを見れば分かります。</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">fcitx-diagnose</code></pre></div>\n<br/>\n<p>後はmatchbox-keyboardをdaemonモードで起動するだけです。</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">matchbox-keyboard -d</code></pre></div>\n<br/>\r\n<br/>\n<p><img src=\"/5a847d0558c6c04f0e9df358b8dc7bf5/matchbox-keyboard-toggle.gif\" alt=\"\"></p>\n<br/>\n<h2 id=\"キオスクモードについてメモ\">キオスクモードについてメモ</h2>\n<h3 id=\"起動時をデスクトップCLIに変更\">起動時をデスクトップ→CLIに変更</h3>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">sudo raspi-config</code></pre></div>\n<p>でメニューが出たら[Boot Options]→[Desktop / CLI]を”Console Autologin”に変更。</p>\n<br/>\n<h3 id=\"matchbox-window-manager-をインストール\">matchbox-window-manager をインストール</h3>\n<p>デスクトップを無効にするとアプリのウィンドウを管理する人が居なくなってしまうので、ウィンドウマネージャを使う。</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">sudo apt install matchbox-window-manager</code></pre></div>\n<br/>\n<h3 id=\"アプリの自動起動\">アプリの自動起動</h3>\n<p>Xorg(Xサーバー)のパーミッション設定。</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">sudo chmod u+s /usr/lib/xorg/Xorg</code></pre></div>\n<br/>\n<p>起動時に呼び出すスクリプトを作成。</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">tee /home/pi/kiosk.sh &lt;&lt;EOF\r\n#!/bin/sh\r\n\r\nxset s off\r\nxset -dpms\r\n\r\nexport QT_IM_MODULE=fcitx\r\nexport GTK_IM_MODULE=fcitx\r\nexport XMODIFIERS=@im=fcitx\r\n\r\nfcitx\r\n\r\nmatchbox-window-manager -use_cursor no -use_titlebar no &amp;\r\nmatchbox-keyboard -d &amp;\r\nchromium-browser --noerrdialogs --disable-infobars --touch-devices=6 --kiosk http://example.com\r\nEOF</code></pre></div>\n<br/>\n<p>流れは以下の通り</p>\n<ol>\n<li>スクリーンセーバー設定\n<ul>\n<li><code class=\"language-text\">xset s off</code> : スクリーンセーバーオフ</li>\n<li><code class=\"language-text\">xset -dpms</code> : 省電力設定オフ</li>\n</ul>\n</li>\n<li>インプットメソッドにfcitxを設定</li>\n<li>fcitxを起動</li>\n<li>ウィンドウマネージャ起動</li>\n<li>matchbox-keybaordをdaemonモードで起動</li>\n<li>chromium-browserを起動\n<ul>\n<li>環境によってはchromium-browserではなくchromiumかもしれない。</li>\n<li><code class=\"language-text\">--noerrdialogs</code> : エラーダイアログを抑制</li>\n<li><code class=\"language-text\">--disable-infobars</code> : 情報バー?を無効にする。最新のchromiumではこのオプションは使えないらしいので無くてもいいかも</li>\n<li><code class=\"language-text\">--touch-devices=6</code> : xinput listでタッチパネルの番号を確認して入れる</li>\n<li><code class=\"language-text\">--kiosk</code> : キオスクモード(全画面)</li>\n</ul>\n</li>\n</ol>\n<br/>\n<p>以下の様にサービスを追加する。</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">sudo tee /etc/systemd/system/kiosk.service &lt;&lt;EOF\r\n[Unit]\r\nDescription=Kiosk service\r\nAfter=network-online.target\r\n[Service]\r\nEnvironment=DISPLAY=:0.0\r\nEnvironment=XAUTHORITY=/home/pi/.Xauthority\r\nType=simple\r\nExecStart=/usr/bin/xinit /home/pi/kiosk.sh -- -nocursor\r\nRestart=on-abort\r\nUser=pi\r\nGroup=pi\r\n[Install]\r\nWantedBy=multi-user.target\r\nEOF\r\n\r\nsudo systemctl enable kiosk</code></pre></div>\n<br/>","frontmatter":{"title":"［Raspberry Pi］オンスクリーンキーボードを自動オンオフする","date":"2022-02-16T01:41:07.093+09:00","description":"","tags":["Raspberry Pi","備忘録"]}}},"pageContext":{"slug":"/posts/DwWRLqqwf","previous":{"fields":{"slug":"/posts/eIuvZu4EJ"},"frontmatter":{"title":"野菜 | プログラミング用語辞典"}},"next":{"fields":{"slug":"/posts/4NiiPGx9e"},"frontmatter":{"title":"［Windows］ Windows Update のエラー 0x80072F8F & 証明書の失効チェックエラー 0x80092013 の対処方法"}}}},"staticQueryHashes":["2841359383","3115688470","3159585216","523898683","998201107"],"slicesMap":{}}