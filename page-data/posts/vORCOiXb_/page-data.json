{"componentChunkName":"component---src-templates-blog-post-js","path":"/posts/vORCOiXb_/","result":{"data":{"markdownRemark":{"id":"3d3af093-dc88-5758-b62e-bfdb9dccc62e","excerpt":"記事一覧 その1（調査編） その2（USB編） その3（Nucleo編）　←ココ その4（ケーブル編） その5（最終章） PS1と接続…の前に Arduino⇔ゲームパッドができたので、後はPS1とArduinoで通信すれば完成だ！と思ったのだけど、ここで問題が発生。\r\nPS1との通信はSPI通信で、USB…","html":"<p>記事一覧</p>\n<ul>\n<li><a href=\"/posts/mmx5El0Si\">その1（調査編）</a></li>\n<li><a href=\"/posts/2stNWIQ7Z\">その2（USB編）</a></li>\n<li><a href=\"/posts/vORCOiXb_\">その3（Nucleo編）</a>　←ココ</li>\n<li><a href=\"/posts/2fluV8sa5\">その4（ケーブル編）</a></li>\n<li><a href=\"/posts/kuG0eT691\">その5（最終章）</a></li>\n</ul>\n<h1 id=\"PS1と接続の前に\">PS1と接続…の前に</h1>\n<p>Arduino⇔ゲームパッドができたので、後はPS1とArduinoで通信すれば完成だ！と思ったのだけど、ここで問題が発生。\r\nPS1との通信はSPI通信で、USBホストシールドとArduinoの通信もSPI通信。Arduino UNOにはSPI通信ポートが一つしかないので両方同時に行うのは不可能だった。どちらもArduinoがマスター側なら問題ないのだけど、PS1との通信ではPS1がマスターなので…</p>\n<p>そこで以下の案を考えた</p>\n<ol>\n<li>PS1⇔Arduino⇐(SPI以外の通信)⇒Arduino⇔ゲームパッド</li>\n<li>SPIを複数使えるマイコン</li>\n</ol>\n<p>1.の案はできそうではあるけど何かダサくて嫌だったので、2.の案をメインに考えた。<br>\nすると！丁度持ってました。STM32 NUCLEO-F401RE です。</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 250px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/36b26a1b663f03b194f1b84295a1b6bc/0479a/nucleo.jpg\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 100%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAAUABQDASIAAhEBAxEB/8QAGAABAAMBAAAAAAAAAAAAAAAAAAEDBAX/xAAWAQEBAQAAAAAAAAAAAAAAAAAAAQL/2gAMAwEAAhADEAAAAe9RTnNLauwmJB//xAAaEAEBAAIDAAAAAAAAAAAAAAABAwACERMg/9oACAEBAAEFAlA7h1LuV1aMNea+P//EABgRAAIDAAAAAAAAAAAAAAAAAAABEBFR/9oACAEDAQE/AS1k/wD/xAAUEQEAAAAAAAAAAAAAAAAAAAAg/9oACAECAQE/AR//xAAgEAABAgUFAAAAAAAAAAAAAAABABECEjEycSAhQVFh/9oACAEBAAY/AnKLV6VhOFNCdhx6i1sNc6f/xAAdEAEAAgICAwAAAAAAAAAAAAABABExQSAhUWGR/9oACAEBAAE/Ib0UQQBqWLcYfUIOs4UY8vc64rc3xf/aAAwDAQACAAMAAAAQGM8A/8QAGBEAAgMAAAAAAAAAAAAAAAAAAAEQIfH/2gAIAQMBAT8QTse6f//EABgRAAIDAAAAAAAAAAAAAAAAAAABEBFR/9oACAECAQE/EC1k/wD/xAAeEAEAAwACAgMAAAAAAAAAAAABABExIVEQQWGRof/aAAgBAQABPxBEMvbLNdhUoLr8fqa0mpq+pTcCcb8H2OmMVKBU54DgWtQAyUXdc9wAw3x//9k='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"nucleo\"\n        title=\"\"\n        src=\"/static/36b26a1b663f03b194f1b84295a1b6bc/0479a/nucleo.jpg\"\n        srcset=\"/static/36b26a1b663f03b194f1b84295a1b6bc/a80bd/nucleo.jpg 148w,\n/static/36b26a1b663f03b194f1b84295a1b6bc/0479a/nucleo.jpg 250w\"\n        sizes=\"(max-width: 250px) 100vw, 250px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p>こちら2000円くらいで買えるSTM32F4マイコンの評価ボードで、mbed開発環境で使えたり、オンチップデバッガが使えたり、Arduino互換ピンを持っていたり、SPI通信ポートが3つもあったりしてかなり高性能。今回の目的にドンピシャだった。</p>\n<p>というわけでNUCLEO-F401REを使うことに決定。</p>\n<h2 id=\"開発環境\">開発環境</h2>\n<p>Nucleoで開発するときはmbedが楽なのだけど、今回は元々Arduinoで作っていたし、<a href=\"https://www.arduinolibraries.info/libraries/usb-host-shield-library-2-0\">USB Host Shield Library 2.0</a> がArduino用のライブラリだったこともありArduino開発環境で開発をすることにした。</p>\n<p>Arduino開発環境でNucleo使うにはstm32duinoというのを導入するんだけど、それは<a href=\"https://github.com/stm32duino/Arduino_Core_STM32#getting-started\">stm32duinoのgithub</a>とか<a href=\"https://www.denshi.club/pc/nucleo/nucleoarduino1blink.html\">このへん</a>を参考にするとできる。</p>\n<p>加えて、Arduino開発環境を使う必要があるけど、Arduino IDEは使い辛くて嫌になったのでVS Codeを使うことにした。VS Codeの拡張機能で<a href=\"https://marketplace.visualstudio.com/items?itemName=vsciot-vscode.vscode-arduino\">Arduino</a>と<a href=\"https://marketplace.visualstudio.com/items?itemName=ms-vscode.cpptools\">C++</a>のやつを入れればコード補間も効くし最高。さらに<a href=\"http://kunukunu.hatenablog.com/entry/posts/190509\">このへん</a>を参考にしてデバッガも使えるようにした。この辺りは今度別記事で書くかもしれない。</p>\n<h1 id=\"NucleoUSBゲームパッド\">Nucleo⇔USBゲームパッド</h1>\n<p>USBホストシールドはNucleoの互換ピンに直接挿せるのだけど、そのままでは動かない。Arduino UnoではSPI関連のピンをまとめたピンが出ているけど、Nucleoにはそれが無い。USBホストシールドはそのピンを使っていて、周りについているArduinoピンソケットにもつながれていなかった。</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/01f064031294f650387dedf30aecb129/f705a/pic01.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 47.972972972972975%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAYAAAC0VX7mAAAACXBIWXMAABcRAAAXEQHKJvM/AAACRUlEQVR42n1S70tTURi+f0T1sU+R+1Qh/SAkkIr60JeyD9nAmhlIWDmZhk10aaNYmJrE8EduwiD8IgWWNrOMNCIYGETESmpzd7s5trtqbXfec8/7xLn7UX7pwMvLufc5z3nO8z4SAIlzLon+n9pBRDoRAQCJzjk3q/StsgTYzxjzE+BHsXwZTfM9nZ17MjIy0ljC7BSE4gDnfDMDgNxqCqn5MPSsZqqr/AgG5xCLREGyjGQiAQJ6BSERWQDohmGYClVVRXB+Hmtrsnnu2+UZfGyYQsSzaN7OvoQ/sear7ayqvoPZbF0sdNutQTbBnSWFFs65qTAe+0re+8NwuScwODSKpeUFrI69wcrxB5AHlyC9XwnhSJ0VB1ruoubmY2yz9mNXXbfeP/Uc2UzSqWVVKZ/PmwoTiSguXDxP3rEAWluvweW6BX/gEUIfwuB5vejh4Zpq1J5qwNFmF7Y0jWJrvRvb6+x6W58HUTnmTCgJ6dePjEno6e1B3xkb9V9xYDIwjTaHC91dHRXLiBOkyfFh7D7ZhOrTl3CssR37T5yFzzeha4UNgXGKSwvZvCWWXNczn1fxdshL0z0DuOd9iNpDByFeKJbwV0zc9PDOeIDt2buPnWuxsxevlxkArQTq1AobUk7bsMzMLuqR9TQKSpziEQV2x3UMDXg2kZUJAa5j9uUrxNI/i1ujkq8b5aGIJ6u/C/ieVimVTsEwGJhRTEg5iyYhJ1ogYAGlYoyJ/gzAOyKyEpGITVU5h/lcjhRF+evbP2RiKH8AFg6WXug3zXgAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"pic01\"\n        title=\"\"\n        src=\"/static/01f064031294f650387dedf30aecb129/fcda8/pic01.png\"\n        srcset=\"/static/01f064031294f650387dedf30aecb129/12f09/pic01.png 148w,\n/static/01f064031294f650387dedf30aecb129/e4a3f/pic01.png 295w,\n/static/01f064031294f650387dedf30aecb129/fcda8/pic01.png 590w,\n/static/01f064031294f650387dedf30aecb129/efc66/pic01.png 885w,\n/static/01f064031294f650387dedf30aecb129/c83ae/pic01.png 1180w,\n/static/01f064031294f650387dedf30aecb129/f705a/pic01.png 1493w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/b75d6e8338e319ae53176d38a0ae253b/18539/pic02.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 81.75675675675677%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAQCAYAAAAWGF8bAAAACXBIWXMAABcRAAAXEQHKJvM/AAAEOklEQVR42k3T+2+TVRgH8KeXKYpbNE4xcYIIiRITY+IfoP6gP8A/AJIYl6JRGLAWxCCRqGSQSdhQJyjOEMCEwdhgYVvXrStj3dbrunZt1/Xy9m233nZxXdfbS/vufM27cTvJOT+ck/PJeZ7zPEQPB8fPKsKRWQpHYqoQF0WQi4iRaJzxkVnw/AyiMwnEEguIJxcRTy1ibj5dWskJKBTLzQWhTPlCSVEolunxCHCcIhDiKBjmVf5QANzMrOiZDrCe663Qtjaiv+smgtEYIvE58Il5xBfSpWxeQEFYbRYeMMoXy4pCUXwCTgX8Cn84REGeV5nsVtjdbnFwZJSdPfgZ/v7qE/z7y3EM2xywTXphmvTBw0VLgXAY+WK5OZsrUjqTUxSEp0C706XICAItLqX3HTt2DHt27xYNEnj0G7R+p8LN307B5HRjbNyJXsMwbt3tKx3//gcsZ3Ln+WiM3L6AopDJETFan6MXLypdplGyTU3V1tXV4dffW8Rhk5kNDg3jnnEEHbfaMGK1wuSYhMXlw9W2jpJafRRZQWyKJeYp1NauWAKegCCiy8tLNHTlysH9dXXo6tWKfXo9GzAY0N2rhd3lhssfgt3jBxebx4U/L5UP1x9BNj53MR6Jrd1ffWfHY/D5QlXVVhBVTWg0p2q/qMX1jk6xTz/Amhp/wojZhOBMDL4wD4d3GhOeabS0/CGe+LkBgk7fC6J3H7y17RUJlbAXGNEW7qMPN3Te6aA7Wm1tveYI7vbrRZ1hkF29dhW7du7EiMUCo8UKo8UOHx/Hnd7+0smTP6IgiM1xgMTKyg+YUvmsBG5mRApJv6vTkk6nUx0/cQJDJpM4arMzm9uDs+fOYYrjMeH14XRjI+rValxru1Haf+AQltPZ8/HWy1Tc8mY1I3pbAt+QwnaePq0cd4yTw+lSHTx0GINGo3jfZGbdfX3QDgwgnl6BY2oaDWfOQK1R40ZnV0mj+RaZ5XxzYKWwlkNGtENaaiTQd+kvZZjnKMSFVWrNERittrU6/HzvHuz/+kvY3D7cN9sxapuA08+js6e/VHfgEJbS2WZntrgOymSbJXCLBCYaGioiqSTxfER1s70dvlCwFE4kxZ6BPrH99i2xW9sjjjnGxcRKVkz+lxGnAiFhUG/AykqxaX7C/eiF26VlKyPaKG1E+w0UjKX2RaX2isUQmVtA0uHCzKgJkdQCkj4/FsxWpDJ5LOcEMADlVVwQAGI1NVLq3pNAufQx5erqGgmdGR7ZG5708hGPzxsbs3iSQ0Zzyhc0p5ZylgVu1pLp6rZk9PesWcN9kzBm8a523D4FotdZZeU2tnGj7OnCfo7J5ZtAVA2il0D0Mojk+PhTqboqHrUo/rlNAMgLUB6gMrAerlJJTC5/0ilsPalrh4/mLiJ6kahSQfR+xYYNmyqINj8jk736Wr1GKaG6h9hDUMbkMvof9uIN5zjHoWkAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"pic02\"\n        title=\"\"\n        src=\"/static/b75d6e8338e319ae53176d38a0ae253b/fcda8/pic02.png\"\n        srcset=\"/static/b75d6e8338e319ae53176d38a0ae253b/12f09/pic02.png 148w,\n/static/b75d6e8338e319ae53176d38a0ae253b/e4a3f/pic02.png 295w,\n/static/b75d6e8338e319ae53176d38a0ae253b/fcda8/pic02.png 590w,\n/static/b75d6e8338e319ae53176d38a0ae253b/efc66/pic02.png 885w,\n/static/b75d6e8338e319ae53176d38a0ae253b/18539/pic02.png 1074w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p>ということで、Nucleoで使うにはそれとピンソケットをジャンパ線でつないでやる必要がある。</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/83a2c98a2795c201a210ff1f35a092ab/98b29/pic03.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 80.4054054054054%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAQCAYAAAAWGF8bAAAACXBIWXMAABcRAAAXEQHKJvM/AAAEX0lEQVR42l3S+0+TZxQH8EMozDiNy8QlLnG/TKNLluwH5/YHzGxuWbYsauKmCDJDvDSKFzS6uXmJi0QUN4xQq4hTQW4Vh6XIpTdabHlbitD2lV7ety29vC13RXDw1O/SLjPbTvKc5zm/fHLOk0NiIEyRmESxeEImiMOczx+ETwgyMRhGOJpARBpPn3B0BKFhCeFIIv2WEhPs6fQsZmbnHfHYaDYAmpyaJurSGylVBKUJmU8IcENeH7xikHmFICyGTlgeqmDVasDzQ4iPP0MkPgZpdBLSyCQbn3yO6Zk5B4DM9es/TTvpdPzYudSd6Rpyc7z/CYRIjJltdlz95ShqTxVC+dMe6HVd4Fw8Bn0CbLwXojTCJp8/w3wSfVu2fPcGEb1p7H6UQR+u+yiTiGRSdDbL7fFYr1XfxIO2dqbu0uHUzk1QFm6AYtcXMOm1MFrs6BvkYelzod/pSapUzXDzHn7lqlXvEtGK1avXyCg7O3sZEX2wes37b7eo1QMfr1sLuXxPUmc2oeL8adSWn8XN0h/Q3PEA7YMDUJkMqGptQ1VbW3LDps24fu0G//XGjSuI6J3Fixcvos82fJ5BRJkAsi5cvMDlbiuEqlnH1BozWlp7YNA/RuXtOlRozqGDq0SrpQLt3WWobznG9hV9icaGPwYLd32fAt9buHDh0r8/kmhp/vaCt06eOTNwMH8X1Fd+Zx3VjXjUoEFDqRK/XWmExd0I12M7/P29GLZ2ovl6OTtQsA3dZuvjbr1uEREtWr58+WuUk5OTTUSv36y6vaT46NH+vd/mQn+7nnXduouy/XIMKq+gtakTZs99DHl4OKwmmAxaXFJUse07ChGLJvoAyMp+Lad0LFiwYAkRrdwtP7jsxIkfHfnyYtRp7aym1YCSqgYUbc5D+ckLeOi4g26jDm5HLwI+D1o6dOxw8RFEY4nU2qT30GDsyUijx4+fTo2eoVBe7S0pPQ9rn511aTtgfRLAjk++wfljZ6F11qPbqIXiUglUtbdQd1/Ntm7NhdcrpsCsFDj7ghFVVCozUkWq7UqFgttXdAC2QSfTm0zgfBG0XauBtlmLjoE6mM0GyPM24+fDe1FdW89yc/P+ByaJnK4h+gesvVvHFR06DLvTxTr1Opy7fBUl8iO4V62Cnm9Cj9mIitLTuHNDAZWmixUU7ITXK7wCX6TAJx7/K7CpqYkrOlQMXhCZoacHebv3Q/7VFlRdVELTr4HFZoPH6YDg80KtM7O8vHzwvPdfICPy+gOvQM5m49RtGoRiERaUJBjsfbhXUQNN2WU8qrkFvxBATHQhGhQgRuLMYrVidGzqvyP7hRA5XW6y9lplQiDMhcJRiMEgC4TCCEbjCPI+RO43QmqpRzQ+DmmoH3HRh4lnfzKWBObn4ZgYHc2anpyiubkkkRAYplBEotjImMwvhji/EIIYCLNgKIrQcBSh2BgisTgk3oa424ZRlwXj8QSmns6w2Zk5sPmXDiCZ7jCZfEl/AcRdgouShp+3AAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"pic03\"\n        title=\"\"\n        src=\"/static/83a2c98a2795c201a210ff1f35a092ab/fcda8/pic03.png\"\n        srcset=\"/static/83a2c98a2795c201a210ff1f35a092ab/12f09/pic03.png 148w,\n/static/83a2c98a2795c201a210ff1f35a092ab/e4a3f/pic03.png 295w,\n/static/83a2c98a2795c201a210ff1f35a092ab/fcda8/pic03.png 590w,\n/static/83a2c98a2795c201a210ff1f35a092ab/efc66/pic03.png 885w,\n/static/83a2c98a2795c201a210ff1f35a092ab/98b29/pic03.png 937w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p>こんな感じで。</p>\n<p>これだけではまだ使えなくて、F401xx対応のためには USB Host Shield Library 2.0 のプログラムも少しいじる必要がある。といっても<a href=\"https://github.com/gyojir/USB_Host_Shield_2.0/commit/9a9a8c252c279a36e890fcd623b045195bfed485#diff-4e876da24e2593a74949bb01d23146d8\">こんな感じ</a>でdefineに少し書き加えるだけだけど。</p>\n<p>これでArduinoと同じようにUSBホストシールドが使えるようになった。</p>\n<h1 id=\"NucleoのSPI通信設定\">NucleoのSPI通信設定</h1>\n<p>stm32のプログラムは少し癖があって、GPIOを使ったりSPI通信をするにはHALライブラリというのをごにょごにょする必要がある。多分stm32duinoでラップされているとは思うけど。</p>\n<p>スレーブ側（PS1とのSPI通信）設定は以下のような感じになる。</p>\n<div class=\"gatsby-highlight\" data-language=\"cpp\"><pre class=\"language-cpp\"><code class=\"language-cpp\"><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">MOSI_PIN</span> <span class=\"token expression\">GPIO_PIN_15</span></span>\r\n<span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">MISO_PIN</span> <span class=\"token expression\">GPIO_PIN_14</span></span>\r\n<span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">SCK_PIN</span> <span class=\"token expression\">GPIO_PIN_13</span></span>\r\n<span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">SS_PIN</span> <span class=\"token expression\">GPIO_PIN_12</span></span>\r\n<span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">ACK_PIN</span> <span class=\"token expression\">GPIO_PIN_1</span></span>\r\n\r\n<span class=\"token keyword\">void</span> <span class=\"token function\">SPI_Slave_Init</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">void</span><span class=\"token punctuation\">)</span>\r\n<span class=\"token punctuation\">{</span>\r\n    <span class=\"token function\">__GPIOB_CLK_ENABLE</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n    <span class=\"token function\">__SPI2_CLK_ENABLE</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n\r\n    <span class=\"token comment\">// ---------------------------------------------------</span>\r\n    <span class=\"token comment\">// SPIの設定</span>\r\n    <span class=\"token comment\">// ---------------------------------------------------</span>\r\n    SPI_Slave_Handle<span class=\"token punctuation\">.</span>Instance <span class=\"token operator\">=</span> SPI2<span class=\"token punctuation\">;</span>\r\n    SPI_Slave_Handle<span class=\"token punctuation\">.</span>Init<span class=\"token punctuation\">.</span>Mode <span class=\"token operator\">=</span> SPI_MODE_SLAVE<span class=\"token punctuation\">;</span>\r\n    SPI_Slave_Handle<span class=\"token punctuation\">.</span>Init<span class=\"token punctuation\">.</span>Direction <span class=\"token operator\">=</span> SPI_DIRECTION_2LINES<span class=\"token punctuation\">;</span>\r\n    SPI_Slave_Handle<span class=\"token punctuation\">.</span>Init<span class=\"token punctuation\">.</span>DataSize <span class=\"token operator\">=</span> SPI_DATASIZE_8BIT<span class=\"token punctuation\">;</span>\r\n    SPI_Slave_Handle<span class=\"token punctuation\">.</span>Init<span class=\"token punctuation\">.</span>CLKPolarity <span class=\"token operator\">=</span> SPI_POLARITY_HIGH<span class=\"token punctuation\">;</span>\r\n    SPI_Slave_Handle<span class=\"token punctuation\">.</span>Init<span class=\"token punctuation\">.</span>CLKPhase <span class=\"token operator\">=</span> SPI_PHASE_2EDGE<span class=\"token punctuation\">;</span>\r\n    SPI_Slave_Handle<span class=\"token punctuation\">.</span>Init<span class=\"token punctuation\">.</span>NSS <span class=\"token operator\">=</span> SPI_NSS_SOFT<span class=\"token punctuation\">;</span>\r\n    SPI_Slave_Handle<span class=\"token punctuation\">.</span>Init<span class=\"token punctuation\">.</span>FirstBit <span class=\"token operator\">=</span> SPI_FIRSTBIT_LSB<span class=\"token punctuation\">;</span>\r\n    SPI_Slave_Handle<span class=\"token punctuation\">.</span>Init<span class=\"token punctuation\">.</span>TIMode <span class=\"token operator\">=</span> SPI_TIMODE_DISABLED<span class=\"token punctuation\">;</span>\r\n    SPI_Slave_Handle<span class=\"token punctuation\">.</span>Init<span class=\"token punctuation\">.</span>CRCCalculation <span class=\"token operator\">=</span> SPI_CRCCALCULATION_DISABLED<span class=\"token punctuation\">;</span>\r\n    SPI_Slave_Handle<span class=\"token punctuation\">.</span>Init<span class=\"token punctuation\">.</span>CRCPolynomial <span class=\"token operator\">=</span> <span class=\"token number\">10</span><span class=\"token punctuation\">;</span>\r\n    <span class=\"token function\">HAL_SPI_Init</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>SPI_Slave_Handle<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n\r\n    <span class=\"token comment\">// ---------------------------------------------------</span>\r\n    <span class=\"token comment\">// MISO, MOSI, SCK, SSの設定</span>\r\n    <span class=\"token comment\">// ---------------------------------------------------</span>\r\n    GPIO_InitTypeDef GPIO_InitStruct<span class=\"token punctuation\">;</span>\r\n\r\n    <span class=\"token comment\">// MISO</span>\r\n    GPIO_InitStruct<span class=\"token punctuation\">.</span>Pin <span class=\"token operator\">=</span> MISO_PIN<span class=\"token punctuation\">;</span>\r\n    GPIO_InitStruct<span class=\"token punctuation\">.</span>Mode <span class=\"token operator\">=</span> GPIO_MODE_AF_OD<span class=\"token punctuation\">;</span>    <span class=\"token comment\">// Alternate function 出力</span>\r\n    GPIO_InitStruct<span class=\"token punctuation\">.</span>Pull <span class=\"token operator\">=</span> GPIO_NOPULL<span class=\"token punctuation\">;</span>        <span class=\"token comment\">// プルアップ</span>\r\n    GPIO_InitStruct<span class=\"token punctuation\">.</span>Speed <span class=\"token operator\">=</span> GPIO_SPEED_HIGH<span class=\"token punctuation\">;</span>   <span class=\"token comment\">// ハイスピード</span>\r\n    GPIO_InitStruct<span class=\"token punctuation\">.</span>Alternate <span class=\"token operator\">=</span> GPIO_AF5_SPI2<span class=\"token punctuation\">;</span> <span class=\"token comment\">// Alternate function mappingを参照のこと</span>\r\n    <span class=\"token function\">HAL_GPIO_Init</span><span class=\"token punctuation\">(</span>GPIOB<span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span>GPIO_InitStruct<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n\r\n    <span class=\"token comment\">// SCK, MOSI</span>\r\n    GPIO_InitStruct<span class=\"token punctuation\">.</span>Pin <span class=\"token operator\">=</span> SCK_PIN <span class=\"token operator\">|</span> MOSI_PIN<span class=\"token punctuation\">;</span>\r\n    GPIO_InitStruct<span class=\"token punctuation\">.</span>Mode <span class=\"token operator\">=</span> GPIO_MODE_AF_OD<span class=\"token punctuation\">;</span> <span class=\"token comment\">// Alternate function ドレイン</span>\r\n    GPIO_InitStruct<span class=\"token punctuation\">.</span>Pull <span class=\"token operator\">=</span> GPIO_PULLUP<span class=\"token punctuation\">;</span>     <span class=\"token comment\">// プルアップ</span>\r\n    <span class=\"token function\">HAL_GPIO_Init</span><span class=\"token punctuation\">(</span>GPIOB<span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span>GPIO_InitStruct<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n\r\n    <span class=\"token comment\">// SSの設定</span>\r\n    GPIO_InitStruct<span class=\"token punctuation\">.</span>Pin <span class=\"token operator\">=</span> SS_PIN<span class=\"token punctuation\">;</span>\r\n    GPIO_InitStruct<span class=\"token punctuation\">.</span>Mode <span class=\"token operator\">=</span> GPIO_MODE_AF_OD<span class=\"token punctuation\">;</span> <span class=\"token comment\">// Alternate function ドレイン</span>\r\n    GPIO_InitStruct<span class=\"token punctuation\">.</span>Pull <span class=\"token operator\">=</span> GPIO_PULLUP<span class=\"token punctuation\">;</span>     <span class=\"token comment\">// プルアップ</span>\r\n    <span class=\"token function\">HAL_GPIO_Init</span><span class=\"token punctuation\">(</span>GPIOB<span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span>GPIO_InitStruct<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n    <span class=\"token function\">stm32_interrupt_enable</span><span class=\"token punctuation\">(</span>GPIOB<span class=\"token punctuation\">,</span> SS_PIN<span class=\"token punctuation\">,</span> SPI_isr_func<span class=\"token punctuation\">,</span> GPIO_MODE_IT_FALLING<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n    <span class=\"token function\">HAL_NVIC_SetPriority</span><span class=\"token punctuation\">(</span>EXTI15_10_IRQn<span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>※stm32_interrupt_enableはstm32duinoでのGPIO割り込み設定。</p>\n<p>ACKピンのGPIO設定も必要なので以下のようにする</p>\n<div class=\"gatsby-highlight\" data-language=\"cpp\"><pre class=\"language-cpp\"><code class=\"language-cpp\"><span class=\"token keyword\">void</span> <span class=\"token function\">GPIO_Init</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">void</span><span class=\"token punctuation\">)</span>\r\n<span class=\"token punctuation\">{</span>\r\n    <span class=\"token comment\">// GPIO Ports Clock Enable</span>\r\n    <span class=\"token function\">__GPIOA_CLK_ENABLE</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n    <span class=\"token function\">__GPIOB_CLK_ENABLE</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n    <span class=\"token function\">__GPIOC_CLK_ENABLE</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n\r\n    GPIO_InitTypeDef GPIO_InitStruct<span class=\"token punctuation\">;</span>\r\n    GPIO_InitStruct<span class=\"token punctuation\">.</span>Pin <span class=\"token operator\">=</span> ACK_PIN<span class=\"token punctuation\">;</span>\r\n    GPIO_InitStruct<span class=\"token punctuation\">.</span>Mode <span class=\"token operator\">=</span> GPIO_MODE_OUTPUT_OD<span class=\"token punctuation\">;</span>\r\n    GPIO_InitStruct<span class=\"token punctuation\">.</span>Pull <span class=\"token operator\">=</span> GPIO_NOPULL<span class=\"token punctuation\">;</span>\r\n    <span class=\"token function\">HAL_GPIO_Init</span><span class=\"token punctuation\">(</span>GPIOB<span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span>GPIO_InitStruct<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n\r\n    <span class=\"token function\">HAL_GPIO_WritePin</span><span class=\"token punctuation\">(</span>GPIOB<span class=\"token punctuation\">,</span> ACK_PIN<span class=\"token punctuation\">,</span> GPIO_PIN_SET<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>マスター側（USBホストシールドとのSPI通信）設定は以下のような感じになる</p>\n<div class=\"gatsby-highlight\" data-language=\"cpp\"><pre class=\"language-cpp\"><code class=\"language-cpp\"><span class=\"token comment\">// SPI1 init function</span>\r\n<span class=\"token keyword\">void</span> <span class=\"token function\">SPI_Master_Init</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">void</span><span class=\"token punctuation\">)</span>\r\n<span class=\"token punctuation\">{</span>\r\n    SPI_Handle<span class=\"token punctuation\">.</span>Instance <span class=\"token operator\">=</span> SPI1<span class=\"token punctuation\">;</span>\r\n    SPI_Handle<span class=\"token punctuation\">.</span>Init<span class=\"token punctuation\">.</span>Mode <span class=\"token operator\">=</span> SPI_MODE_MASTER<span class=\"token punctuation\">;</span>\r\n    SPI_Handle<span class=\"token punctuation\">.</span>Init<span class=\"token punctuation\">.</span>Direction <span class=\"token operator\">=</span> SPI_DIRECTION_2LINES<span class=\"token punctuation\">;</span>\r\n    SPI_Handle<span class=\"token punctuation\">.</span>Init<span class=\"token punctuation\">.</span>DataSize <span class=\"token operator\">=</span> SPI_DATASIZE_8BIT<span class=\"token punctuation\">;</span>\r\n    SPI_Handle<span class=\"token punctuation\">.</span>Init<span class=\"token punctuation\">.</span>CLKPolarity <span class=\"token operator\">=</span> SPI_POLARITY_LOW<span class=\"token punctuation\">;</span>\r\n    SPI_Handle<span class=\"token punctuation\">.</span>Init<span class=\"token punctuation\">.</span>CLKPhase <span class=\"token operator\">=</span> SPI_PHASE_1EDGE<span class=\"token punctuation\">;</span>\r\n    SPI_Handle<span class=\"token punctuation\">.</span>Init<span class=\"token punctuation\">.</span>NSS <span class=\"token operator\">=</span> SPI_NSS_SOFT<span class=\"token punctuation\">;</span>\r\n    SPI_Handle<span class=\"token punctuation\">.</span>Init<span class=\"token punctuation\">.</span>BaudRatePrescaler <span class=\"token operator\">=</span> SPI_BAUDRATEPRESCALER_4<span class=\"token punctuation\">;</span>\r\n    SPI_Handle<span class=\"token punctuation\">.</span>Init<span class=\"token punctuation\">.</span>FirstBit <span class=\"token operator\">=</span> SPI_FIRSTBIT_MSB<span class=\"token punctuation\">;</span>\r\n    SPI_Handle<span class=\"token punctuation\">.</span>Init<span class=\"token punctuation\">.</span>TIMode <span class=\"token operator\">=</span> SPI_TIMODE_DISABLED<span class=\"token punctuation\">;</span>\r\n    SPI_Handle<span class=\"token punctuation\">.</span>Init<span class=\"token punctuation\">.</span>CRCCalculation <span class=\"token operator\">=</span> SPI_CRCCALCULATION_DISABLED<span class=\"token punctuation\">;</span>\r\n    SPI_Handle<span class=\"token punctuation\">.</span>Init<span class=\"token punctuation\">.</span>CRCPolynomial <span class=\"token operator\">=</span> <span class=\"token number\">10</span><span class=\"token punctuation\">;</span>\r\n    <span class=\"token function\">HAL_SPI_Init</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>SPI_Handle<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>プルアップの設定とかオープンドレインとかいまいち理解してないけど、とりあえずこれで通信できたので良しとする。</p>\n<h2 id=\"NucleoとArduinoでPS1との通信を模倣\">NucleoとArduinoでPS1との通信を模倣</h2>\n<p>実際にPS1と通信する前に、ArduinoにPS1側の動作をやらせてみました。<br>\nArduino(PS1)側のコードは以下の通り。コイツと通信できれば多分OK？？(OKではなかったが意味はある)</p>\n<div class=\"gatsby-highlight\" data-language=\"cpp\"><pre class=\"language-cpp\"><code class=\"language-cpp\"><span class=\"token comment\">/**********************************************\r\n  Arduino nano SPI(Master)\r\n**********************************************/</span>\r\n<span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;SPI.h></span></span>\r\n\r\n<span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">SS_PIN</span> <span class=\"token expression\"><span class=\"token number\">10</span></span></span>\r\n<span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">BUF_SIZE</span> <span class=\"token expression\"><span class=\"token number\">256</span></span></span>\r\n\r\n<span class=\"token keyword\">static</span> <span class=\"token keyword\">bool</span> <span class=\"token function\">wait_ack</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">void</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n<span class=\"token keyword\">static</span> <span class=\"token keyword\">void</span> <span class=\"token function\">PrintBin</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">uint8_t</span> val<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n\r\n<span class=\"token keyword\">void</span> <span class=\"token function\">setup</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n  Serial<span class=\"token punctuation\">.</span><span class=\"token function\">begin</span><span class=\"token punctuation\">(</span><span class=\"token number\">9600</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n  <span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>Serial<span class=\"token punctuation\">)</span>\r\n\r\n  <span class=\"token function\">pinMode</span><span class=\"token punctuation\">(</span><span class=\"token number\">9</span><span class=\"token punctuation\">,</span> INPUT_PULLUP<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n\r\n  <span class=\"token function\">pinMode</span><span class=\"token punctuation\">(</span>SS_PIN<span class=\"token punctuation\">,</span> OUTPUT<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n  <span class=\"token function\">digitalWrite</span><span class=\"token punctuation\">(</span>SS_PIN<span class=\"token punctuation\">,</span> HIGH<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>    <span class=\"token comment\">//SS</span>\r\n  \r\n  SPI<span class=\"token punctuation\">.</span><span class=\"token function\">setClockDivider</span><span class=\"token punctuation\">(</span>SPI_CLOCK_DIV32<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  <span class=\"token comment\">//fosc/128</span>\r\n  \r\n  <span class=\"token comment\">// SPI_MODE0(アイドル時のクロックがLow、立ち上がりでサンプリング)</span>\r\n  <span class=\"token comment\">// SPI_MODE1(アイドル時のクロックがLow、立ち下がりでサンプリング)</span>\r\n  <span class=\"token comment\">// SPI_MODE2(アイドル時のクロックがHigh、立ち下がりでサンプリング)</span>\r\n  <span class=\"token comment\">// SPI_MODE3(アイドル時のクロックがHigh、立ち上がりでサンプリング)</span>\r\n  SPI<span class=\"token punctuation\">.</span><span class=\"token function\">setDataMode</span><span class=\"token punctuation\">(</span>SPI_MODE3<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n\r\n  SPI<span class=\"token punctuation\">.</span><span class=\"token function\">setBitOrder</span><span class=\"token punctuation\">(</span>LSBFIRST<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n\r\n  SPI<span class=\"token punctuation\">.</span><span class=\"token function\">begin</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>    <span class=\"token comment\">//SPI有効</span>\r\n  Serial<span class=\"token punctuation\">.</span><span class=\"token function\">println</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"/-----START Arduino UNO-----/\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n  Serial<span class=\"token punctuation\">.</span><span class=\"token function\">println</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"/---------SPI Master--------/\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n  Serial<span class=\"token punctuation\">.</span><span class=\"token function\">println</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"/-------Default DIV128------/\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n  <span class=\"token function\">delay</span><span class=\"token punctuation\">(</span><span class=\"token number\">100</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n<span class=\"token punctuation\">}</span>\r\n<span class=\"token keyword\">void</span> <span class=\"token function\">loop</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n  <span class=\"token keyword\">uint8_t</span> rv<span class=\"token punctuation\">;</span>\r\n  <span class=\"token keyword\">uint8_t</span> data<span class=\"token punctuation\">[</span><span class=\"token number\">2</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\r\n\r\n  <span class=\"token function\">digitalWrite</span><span class=\"token punctuation\">(</span>SS_PIN<span class=\"token punctuation\">,</span> LOW<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>    <span class=\"token comment\">//SS 有効</span>\r\n  <span class=\"token punctuation\">{</span>\r\n    SPI<span class=\"token punctuation\">.</span><span class=\"token function\">transfer</span><span class=\"token punctuation\">(</span><span class=\"token number\">0x01</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>    <span class=\"token comment\">//送受信処理</span>\r\n    <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span><span class=\"token function\">wait_ack</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\r\n\r\n      rv <span class=\"token operator\">=</span> SPI<span class=\"token punctuation\">.</span><span class=\"token function\">transfer</span><span class=\"token punctuation\">(</span><span class=\"token number\">0x42</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>    <span class=\"token comment\">//送受信処理</span>\r\n      <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span><span class=\"token function\">wait_ack</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\r\n        <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>rv <span class=\"token operator\">==</span> <span class=\"token number\">0x41</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\r\n          rv <span class=\"token operator\">=</span> SPI<span class=\"token punctuation\">.</span><span class=\"token function\">transfer</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>    <span class=\"token comment\">//送受信処理</span>\r\n          <span class=\"token function\">wait_ack</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n          <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>rv <span class=\"token operator\">==</span> <span class=\"token number\">0x5A</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\r\n            rv <span class=\"token operator\">=</span> SPI<span class=\"token punctuation\">.</span><span class=\"token function\">transfer</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>    <span class=\"token comment\">//送受信処理</span>\r\n            <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span><span class=\"token function\">wait_ack</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\r\n              data<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> rv<span class=\"token punctuation\">;</span>\r\n              \r\n              rv <span class=\"token operator\">=</span> SPI<span class=\"token punctuation\">.</span><span class=\"token function\">transfer</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>    <span class=\"token comment\">//送受信処理</span>\r\n              <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span><span class=\"token function\">wait_ack</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\r\n                data<span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> rv<span class=\"token punctuation\">;</span>\r\n                <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> i <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> i <span class=\"token operator\">&lt;</span> <span class=\"token number\">2</span><span class=\"token punctuation\">;</span> i<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n                  <span class=\"token function\">PrintBin</span><span class=\"token punctuation\">(</span>data<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n                  Serial<span class=\"token punctuation\">.</span><span class=\"token function\">println</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n                <span class=\"token punctuation\">}</span>\r\n              <span class=\"token punctuation\">}</span>\r\n            <span class=\"token punctuation\">}</span>\r\n          <span class=\"token punctuation\">}</span>        \r\n        <span class=\"token punctuation\">}</span>\r\n      <span class=\"token punctuation\">}</span>\r\n    <span class=\"token punctuation\">}</span>\r\n  <span class=\"token punctuation\">}</span>\r\n  <span class=\"token function\">digitalWrite</span><span class=\"token punctuation\">(</span>SS_PIN<span class=\"token punctuation\">,</span> HIGH<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>   <span class=\"token comment\">//SS 終了</span>\r\n\r\n  <span class=\"token function\">delay_us</span><span class=\"token punctuation\">(</span><span class=\"token number\">100</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n<span class=\"token punctuation\">}</span>\r\n\r\n<span class=\"token keyword\">bool</span> <span class=\"token function\">wait_ack</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\r\n  <span class=\"token keyword\">int</span> count <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span>\r\n\r\n  <span class=\"token comment\">// lowになるのを待つ</span>\r\n  <span class=\"token keyword\">while</span><span class=\"token punctuation\">(</span>PINB <span class=\"token operator\">&amp;</span> <span class=\"token function\">_BV</span><span class=\"token punctuation\">(</span>PB1<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\r\n    <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>count<span class=\"token operator\">++</span> <span class=\"token operator\">></span> <span class=\"token number\">5</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\r\n      <span class=\"token keyword\">return</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">;</span>\r\n    <span class=\"token punctuation\">}</span>\r\n  <span class=\"token punctuation\">}</span>\r\n\r\n  <span class=\"token comment\">// highになるのを待つ</span>\r\n  <span class=\"token keyword\">while</span><span class=\"token punctuation\">(</span><span class=\"token operator\">!</span><span class=\"token punctuation\">(</span>PINB <span class=\"token operator\">&amp;</span> <span class=\"token function\">_BV</span><span class=\"token punctuation\">(</span>PB1<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\r\n    <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>count<span class=\"token operator\">++</span> <span class=\"token operator\">></span> <span class=\"token number\">1000</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\r\n      <span class=\"token keyword\">return</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">;</span>\r\n    <span class=\"token punctuation\">}</span>\r\n  <span class=\"token punctuation\">}</span>\r\n  <span class=\"token keyword\">return</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">;</span>\r\n<span class=\"token punctuation\">}</span>\r\n\r\n<span class=\"token keyword\">void</span> <span class=\"token function\">PrintBin</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">uint8_t</span> val<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n  <span class=\"token keyword\">for</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">uint8_t</span> mask <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">uint8_t</span><span class=\"token punctuation\">)</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&lt;&lt;</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">sizeof</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">uint8_t</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&lt;&lt;</span> <span class=\"token number\">3</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> mask<span class=\"token punctuation\">;</span> mask <span class=\"token operator\">>>=</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span>\r\n    <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>val <span class=\"token operator\">&amp;</span> mask<span class=\"token punctuation\">)</span>\r\n      Serial<span class=\"token punctuation\">.</span><span class=\"token function\">print</span><span class=\"token punctuation\">(</span><span class=\"token char\">'1'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n    <span class=\"token keyword\">else</span>\r\n      Serial<span class=\"token punctuation\">.</span><span class=\"token function\">print</span><span class=\"token punctuation\">(</span><span class=\"token char\">'0'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n<span class=\"token punctuation\">}</span>\r\n\r\n<span class=\"token keyword\">void</span> <span class=\"token function\">delay_us</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">uint32_t</span> us<span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\r\n  <span class=\"token comment\">// 16MHz</span>\r\n  <span class=\"token comment\">// 1clock = 1 / 16MHz = 6.25e-8s</span>\r\n  <span class=\"token comment\">// 1us / 6.25e-8 = 16</span>\r\n\r\n  <span class=\"token keyword\">for</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">uint32_t</span> i <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> i <span class=\"token operator\">&lt;</span> us<span class=\"token punctuation\">;</span> i<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\r\n    <span class=\"token keyword\">asm</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"nop;nop;nop;nop;nop;nop;nop;nop;nop;nop;nop;nop;nop;nop;nop;nop;\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n  <span class=\"token punctuation\">}</span>\r\n<span class=\"token punctuation\">}</span></code></pre></div>\n<br>\r\n<br>\n<p><img src=\"/adf54a651323a1f3d60ba72f28a5c63e/connection.jpg\" alt=\"\">\r\n実際につないだ様子</p>\n<p>900円くらいのロジアナにつないで、PulseViewというソフトで計測するとこんな感じになった。</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/66ea0fef4af962dde93c1d8c29215f4f/cf8e5/psxemu_to_gamepad.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 40.54054054054054%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAICAIAAAB2/0i6AAAACXBIWXMAAA7DAAAOwwHHb6hkAAABk0lEQVR42j3JyW7TQACAYb//gRfgEEJy4MQS0lSBCkILrkwS13bTuiResGJ7PN5m8TozdlwJokrf4Zd+6dX05vXH9Wi2Hc824wvt7Vx781kdzbaj2WY8X08u1MlCn14a00tj8mKhv1veTydLKYB5x2vWUN7WgtWirVhF6jJvqlyIsu/4i1MvesH6jneCD0NnB7l0jGl/6lsmGD/johNdz0XHeNcy3nJxvuysbfkwnJ7cSFJ+q3ng5qFPQVCAEIc+Co4oPBZRiIGPgV+AkIAAAZ+A4H+g0G8SoBl7SZflLnWbxOOJV0GniGwW/62gU0Kn/qeMnBLadewQaOXRoY7dIrKrzFa2d5Jm77zocfUgf1Kv3MSy4v0H9avibOMiWO6uF8YKUl87Gu83X8zQDIk31799N2XKwdo0pTAtCE31u8Ov6wdEaZqhn6uddfD5iW2UP4r8xHvmedGPKwNEadlUtzePumYPQ78/QmlnwRQVWU4xpjDBMCEIkTQjIMYIUYQoiHGSEUKKOCVRgjGmaUYyVNxqzjNaX6i7R2k/eAAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"psxemu to gamepad\"\n        title=\"\"\n        src=\"/static/66ea0fef4af962dde93c1d8c29215f4f/fcda8/psxemu_to_gamepad.png\"\n        srcset=\"/static/66ea0fef4af962dde93c1d8c29215f4f/12f09/psxemu_to_gamepad.png 148w,\n/static/66ea0fef4af962dde93c1d8c29215f4f/e4a3f/psxemu_to_gamepad.png 295w,\n/static/66ea0fef4af962dde93c1d8c29215f4f/fcda8/psxemu_to_gamepad.png 590w,\n/static/66ea0fef4af962dde93c1d8c29215f4f/efc66/psxemu_to_gamepad.png 885w,\n/static/66ea0fef4af962dde93c1d8c29215f4f/c83ae/psxemu_to_gamepad.png 1180w,\n/static/66ea0fef4af962dde93c1d8c29215f4f/cf8e5/psxemu_to_gamepad.png 1402w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<br>\n<p>いい感じ！</p>\n<p>これで、あとはPS1と実際に通信するだけ！<br>\n<br>\r\n<br>\r\nつづく。</p>","frontmatter":{"title":"USB GamePad to PSX Controller Converter を作った(3)","date":"2019-02-17T19:01:50.000+09:00","description":"","tags":["製作記"]}}},"pageContext":{"slug":"/posts/vORCOiXb_","previous":{"fields":{"slug":"/posts/2stNWIQ7Z"},"frontmatter":{"title":"USB GamePad to PSX Controller Converter を作った(2)"}},"next":{"fields":{"slug":"/posts/2fluV8sa5"},"frontmatter":{"title":"USB GamePad to PSX Controller Converter を作った(4)"}}}},"staticQueryHashes":["2841359383","3115688470","3159585216","523898683","998201107"],"slicesMap":{}}